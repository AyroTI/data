(function(){var e;e=typeof exports!=="undefined"?exports:this.Data={};e.VERSION="0.6.0";var c=this._;if(!c&&typeof require!=="undefined")c=require("underscore");e.VALUE_TYPES=["string","object","number","boolean","date"];e.isValueType=function(a){return c.include(e.VALUE_TYPES,c.last(a))};e.uuid=function(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),d=[],f=0;f<32;f++)d[f]=b[0|Math.random()*16];return(a?a:"")+d.join("")};e.Query={query:function(a){function b(g,l){var j=true;c.find(l,
function(h,k){var i=k==="type"?g.types:g.properties[k];if(c.intersect(c.isArray(h)?h:[h],c.isArray(i)?i:[i]).length===0){j=false;return true}});return j}var d=this.get(a.type),f=c.select(this.objects,function(g){return b(g,a)});return e.Collection.create(d,f)}};e.Type=function(a){this._id=a._id;this.type="/type/type";this.name=a.name;this.meta=a.meta||{};this.indexes=a.indexes||{};this.properties=a.properties;c.each(this.properties,c.bind(function(b){b.type=c.isArray(b.type)?b.type:[b.type];b.unique=
c.isBoolean(b.unique)?b.unique:true},this))};c.extend(e.Type.prototype,c.Events,{toJSON:function(){return{_id:this._id,type:"/type/type",properties:this.properties,meta:this.meta,indexes:c.map(this.indexes,function(a){return a.properties})}}});e.Object=function(a,b){this._id=a._id;this.host=b;this.properties={};this.set(a)};c.extend(e.Object.prototype,c.Events,{type:function(){return this.host.get(c.last(this.types))},property:function(a){var b=null;c.find(this.types.reverse(),c.bind(function(d){return b=
this.host.get(d).properties[a]},this));return b},get:function(a){var b=this.property(a);a=this.properties[a];if(!b||!a)return null;return e.isValueType(b.type)?a:b.unique?this.host.get(a):c.map(a,c.bind(function(d){return this.host.get(d)},this))},set:function(a){var b=this;if(a.type)this.types=c.isArray(a.type)?a.type:[a.type];if(a.meta)this.meta=this.object.meta;c.each(a,c.bind(function(d,f){!b.property(f)||f==="type"||(b.properties[f]=d)},this))},toJSON:function(){return c.extend(this.properties,
{_id:this._id,type:this.types})}});e.Graph=function(a){this.nodes=[];this.objects=[];this.types=[];this.keys={};a&&this.merge(a)};c.extend(e.Graph.prototype,e.Query,c.Events,{merge:function(a){c.each(a,c.bind(function(b,d){this.set(c.extend(b,{_id:d}))},this));return this},get:function(a){return this.nodes[this.keys[a]]},set:function(a){function b(){return c.last(d)==="/type/type"?new e.Type(a):new e.Object(a,this)}var d=c.isArray(a.type)?a.type:[a.type];a._id=a._id?a._id:e.uuid("/"+c.last(c.last(d).split("/"))+
"/");var f=this.get(a._id);if(f)f.set(a);else{f=b.apply(this);this.keys[a._id]=this.nodes.length;this.nodes.push(f);c.last(d)==="/type/type"?this.types.push(f):this.objects.push(f)}return f},find:function(a){return this.query(a)},del:function(a){if(a=this.get(a))a._deleted=true},toJSON:function(){var a={};c.each(this.nodes,function(b){a[b._id]=b.toJSON()});return a}});e.Collection=function(a){this.type=new e.Type(a.type,this);this.objects=[];this.length=0;this.keys={};c.each(a.objects,c.bind(function(b){this.add(b)},
this))};e.Collection.create=function(a,b){var d=new e.Collection({type:a,objects:[]});d.objects=b;d.length=b.length;c.each(b,function(f,g){d.keys[f._id]=g});return d};c.extend(e.Collection.prototype,c.Events,e.Query,{get:function(a){if(a.match("^/type/"))return this.type;return this.objects[this.keys[a]]},at:function(a){return this.objects[a]},index:function(a){return this.keys[a]},key:function(a){return this.objects[a]._id},add:function(a){var b;if(a instanceof e.Object){b=a;this.keys[b._id]=this.objects.length;
this.objects.push(b);this.length=this.objects.length}else{a._id=a._id?a._id:e.uuid("/"+c.last(this.type._id.split("/"))+"/");a.type=this.type._id;if(b=this.get(a._id))b.set(a);else{b=new e.Object(a,this);this.keys[b._id]=this.objects.length;this.objects.push(b);this.length=this.objects.length}}return b},find:function(a){a.type=this.type._id;return this.query(a)},each:function(a){c.each(this.objects,function(b,d){a.call(this,b,b._id,d)},this);return this},first:function(){return this.length>0?this.objects[0]:
null},last:function(){return this.length>0?this.objects[this.length-1]:null},intersect:function(a){var b=new e.Collection.create(this.type,[]),d,f;if(a.length<this.length){d=a;f=this}else{d=this;f=a}c.each(d.objects,function(g){f.get(g._id)&&b.add(a.get(g._id))});return b},union:function(a){var b=new e.Collection.create(this.type,[]);this.each(function(d){b.add(d)});a.each(function(d,f){b.get(f)||b.add(d)});return b},difference:function(a){result=new e.Collection.create(this.type,[]);this.each(function(b,
d){a.get(d)||result.add(b)});return result},toJSON:function(){return{type:this.type.toJSON(),objects:c.map(this.objects,function(a){return a.toJSON()})}}})})();
