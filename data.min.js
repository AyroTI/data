(function(){var d;d=typeof exports!=="undefined"?exports:this.Data={};d.VERSION="0.6.0";var b=this._;if(!b&&typeof require!=="undefined")b=require("underscore");d.VALUE_TYPES=["string","object","number","boolean","date"];d.isValueType=function(a){return b.include(d.VALUE_TYPES,b.last(a))};d.uuid=function(a){for(var c="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=[],f=0;f<32;f++)e[f]=c[0|Math.random()*16];return(a?a:"")+e.join("")};d.Query={query:function(a){function c(g,l){var j=true;b.find(l,
function(h,k){var i=k==="type"?g.types:g.properties[k];if(b.intersect(b.isArray(h)?h:[h],b.isArray(i)?i:[i]).length===0){j=false;return true}});return j}var e=this.get(a.type),f=b.select(this.objects,function(g){return c(g,a)});return d.Collection.create(e,f)}};d.Type=function(a){this._id=a._id;this.type="/type/type";this.name=a.name;this.meta=a.meta||{};this.indexes=a.indexes||{};this.properties=a.properties;b.each(this.properties,b.bind(function(c){c.type=b.isArray(c.type)?c.type:[c.type];c.unique=
b.isBoolean(c.unique)?c.unique:true},this))};b.extend(d.Type.prototype,b.Events,{toJSON:function(){return{_id:this._id,type:"/type/type",properties:this.properties,meta:this.meta,indexes:b.map(this.indexes,function(a){return a.properties})}}});d.Object=function(a,c){this._id=a._id;this.host=c;this.properties={};this.set(a)};b.extend(d.Object.prototype,b.Events,{type:function(){return this.host.get(b.last(this.types))},property:function(a){var c=null;b.find(this.types.reverse(),b.bind(function(e){return c=
this.host.get(e).properties[a]},this));return c},get:function(a){var c=this.property(a);a=this.properties[a];if(!c||!a)return null;return d.isValueType(c.type)?a:c.unique?this.host.get(a):b.map(a,b.bind(function(e){return this.host.get(e)},this))},set:function(a){var c=this;if(a.type)this.types=b.isArray(a.type)?a.type:[a.type];if(a.meta)this.meta=this.object.meta;b.each(a,b.bind(function(e,f){!c.property(f)||f==="type"||(c.properties[f]=e)},this))},toJSON:function(){return b.extend(this.properties,
{_id:this._id,type:this.types})}});d.Graph=function(a){this.nodes=[];this.objects=[];this.types=[];this.keys={};a&&this.merge(a)};b.extend(d.Graph.prototype,d.Query,b.Events,{merge:function(a){b.each(a,b.bind(function(c,e){this.set(b.extend(c,{_id:e}))},this));return this},get:function(a){return this.nodes[this.keys[a]]},set:function(a){function c(){return b.last(e)==="/type/type"?new d.Type(a):new d.Object(a,this)}var e=b.isArray(a.type)?a.type:[a.type];a._id=a._id?a._id:d.uuid("/"+b.last(b.last(e).split("/"))+
"/");var f=this.get(a._id);if(f)f.set(a);else{f=c.apply(this);this.keys[a._id]=this.nodes.length;this.nodes.push(f);b.last(e)==="/type/type"?this.types.push(f):this.objects.push(f)}return f},find:function(a){return this.query(a)},del:function(a){if(a=this.get(a))a._deleted=true},toJSON:function(){var a={};b.each(this.nodes,function(c){a[c._id]=c.toJSON()});return a}});d.Collection=function(a){this.type=new d.Type(a.type,this);this.objects=[];this.length=0;this.keys={};b.each(a.objects,b.bind(function(c){this.add(c)},
this))};d.Collection.create=function(a,c){var e=new d.Collection({type:a,objects:[]});e.objects=c;e.length=c.length;b.each(c,function(f,g){e.keys[f._id]=g});return e};b.extend(d.Collection.prototype,b.Events,d.Query,{get:function(a){if(a.match("^/type/"))return this.type;return this.objects[this.keys[a]]},at:function(a){return this.objects[a]},index:function(a){return this.keys[a]},key:function(a){return this.objects[a]._id},add:function(a){a._id=a._id?a._id:d.uuid("/"+b.last(this.type._id.split("/"))+
"/");a.type=this.type._id;var c=this.get(a._id);if(c)c.set(a);else{c=new d.Object(a,this);this.keys[c._id]=this.objects.length;this.objects.push(c);this.length=this.objects.length}return c},find:function(a){a.type=this.type._id;return this.query(a)},each:function(a){b.each(this.objects,function(c,e){a.call(this,c,c._id,e)},this);return this},toJSON:function(){return{type:this.type.toJSON(),objects:b.map(this.objects,function(a){return a.toJSON()})}}})})();
