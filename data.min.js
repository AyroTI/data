(function(){var f;f=typeof exports!=="undefined"?exports:this.Data={};f.VERSION="0.6.0";var c=this._;if(!c&&typeof require!=="undefined")c=require("underscore");f.VALUE_TYPES=["string","object","number","boolean","date"];f.isValueType=function(a){return c.include(f.VALUE_TYPES,c.last(a))};f.permute=function(a){if(a.length==1)return a[0];else{for(var b=[],e=f.permute(a.slice(1)),d=0;d<e.length;d++)for(var g=0;g<a[0].length;g++)b.push(a[0][g]+e[d]);return b}};f.wrap=function(a,b){var e=new f.Collection({type:a,
objects:[]});e.objects=b;c.each(b,function(d,g){e.keys[d._id]=g})};f.uuid=function(a){for(var b="0123456789abcdefghijklmnopqrstuvwxyz".split(""),e=[],d=0;d<32;d++)e[d]=b[0|Math.random()*16];return(a?a:"")+e.join("")};c.Events={bind:function(a,b){this._callbacks||(this._callbacks={});(this._callbacks[a]||(this._callbacks[a]=[])).push(b);return this},unbind:function(a,b){var e;if(a){if(e=this._callbacks)if(b){e=e[a];if(!e)return this;for(var d=0,g=e.length;d<g;d++)if(b===e[d]){e.splice(d,1);break}}else e[a]=
[]}else this._callbacks={};return this},trigger:function(a){var b,e,d,g;if(!(e=this._callbacks))return this;if(b=e[a]){d=0;for(g=b.length;d<g;d++)b[d].apply(this,Array.prototype.slice.call(arguments,1))}if(b=e.all){d=0;for(g=b.length;d<g;d++)b[d].apply(this,arguments)}return this}};f.Type=function(a){this._id=a._id;this.type="/type/type";this.name=a.name;this.objects=[];this.meta=a.meta||{};this.built=false;a.indexes&&this.setupIndexes(a.indexes);this.properties=a.properties;c.each(this.properties,
c.bind(function(b){b.type=c.isArray(b.type)?b.type:[b.type];b.unique=c.isBoolean(b.unique)?b.unique:true},this))};c.extend(f.Type.prototype,c.Events,{setupIndexes:function(a){var b=this;this.indexes={};c.each(a,function(e,d){b.indexes[d]={properties:e,objects:{}}})},buildIndexes:function(){function a(e,d){var g=[];c.each(d.properties,function(h){h=e.properties[h];g.push(c.isArray(h)?h:[h])});c.each(f.permute(g),function(h){var i=d.objects[h];i||(i=d.objects[h]=[]);i.push(e)})}var b=this;c.each(this.objects,
function(e){c.each(b.indexes,function(d){a(e,d)})});this.built=true},find:function(a){this.built||this.buildIndexes();var b=c.select(this.indexes,function(d){return c.intersect(Object.keys(a),d.properties).length===d.properties.length})[0];if(!b)return console.log("No index found.");var e="";c.each(b.properties,function(d){e+=a[d]});return b.objects[e]||[]},toJSON:function(){return{_id:this._id,type:"/type/type",properties:this.properties,meta:this.meta,indexes:c.map(this.indexes,function(a){return a.properties})}}});
f.Object=function(a,b){this._id=a._id;this.host=b;this.properties={};this.set(a)};c.extend(f.Object.prototype,c.Events,{type:function(){return this.host.get(c.last(this.types))},toString:function(){return this.get("name")||this.val||this._id},property:function(a){var b=null;c.find(this.types.reverse(),c.bind(function(e){return b=this.host.get(e).properties[a]},this));return b},get:function(a){var b=this.property(a);a=this.properties[a];if(!b||!a)return null;return f.isValueType(b.type)?a:b.unique?
this.host.get(a):c.map(a,c.bind(function(e){return this.host.get(e)},this))},set:function(a){var b=this;if(a.type)this.types=c.isArray(a.type)?a.type:[a.type];if(a.meta)this.meta=this.object.meta;c.each(a,c.bind(function(e,d){if(!(!b.property(d)||d==="type")){b.properties[d]=e;b._dirty=true}},this))},toJSON:function(){return c.extend(this.properties,{_id:this._id,type:this.types})}});f.Graph=function(a,b){this.nodes=[];this.objects=[];this.types=[];this.keys={};a&&this.merge(a,b&&b.dirty)};c.extend(f.Graph.prototype,
c.Events,{merge:function(a){c.each(a,c.bind(function(b,e){this.set(c.extend(b,{_id:e}))},this));return this},find:function(a){var b=this.get(a.type);delete a.type;return Object.keys(a).length===0?b.objects:b.find(a)},set:function(a,b){function e(){return c.last(d)==="/type/type"?new f.Type(a):new f.Object(a,this)}if(b===undefined)b=true;var d=c.isArray(a.type)?a.type:[a.type];a._id=a._id?a._id:f.uuid("/"+c.last(c.last(d).split("/"))+"/");var g=this.get(a._id);if(g)g.set(a);else{g=e.apply(this);this.keys[a._id]=
this.nodes.length;this.nodes.push(g);if(c.last(d)==="/type/type")this.types.push(g);else{this.objects.push(g);c.each(g.types,function(h){this.get(h).objects.push(g)},this)}}return g},get:function(a){return this.nodes[this.keys[a]]},del:function(a){if(a=this.get(a)){a._deleted=true;a._dirty=true}},toJSON:function(){var a={};c.each(this.nodes,function(b){a[b._id]=b.toJSON()});return a}});f.Collection=function(a){this.type=new f.Type(a.type,this);this.objects=this.type.objects;this.keys={};c.each(a.objects,
c.bind(function(b){this.add(b)},this))};c.extend(f.Collection.prototype,{get:function(a){if(a.match("^/type/"))return this.type;return this.objects[this.keys[a]]},add:function(a){a._id=a._id?a._id:f.uuid("/"+c.last(this.type._id.split("/"))+"/");a.type=this.type._id;var b=this.get(a._id);if(b)b.set(a);else{b=new f.Object(a,this);this.keys[b._id]=this.objects.length;this.type.objects.push(b);this.objects.push(b)}return b},find:function(a){return this.type.find(a)},toJSON:function(){return{type:this.type.toJSON(),
objects:c.map(this.objects,function(a){return a.toJSON()})}}})})();
